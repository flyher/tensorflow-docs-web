<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>自定义数据读取</title>
    <link href="//xitu.github.io/tensorflow-docs-web/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="//xitu.github.io/tensorflow-docs-web/assets/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
</head>
<body>
<!-- Header start -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">TensorFlow</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
        </ul>
        <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form>
    </div>
</nav>
<script>
    var head = [{'link': '//xitu.github.io/tensorflow-docs-web/extend/index.html', 'name': '扩展', 'selected': 1}, {'link': '//xitu.github.io/tensorflow-docs-web/install/index.html', 'name': '安装 TensorFlow', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/deploy/index.html', 'name': '部署', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/about/index.html', 'name': 'About TensorFlow', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/get_started/index.html', 'name': '开始', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/mobile/index.html', 'name': 'Overview', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/tutorials/index.html', 'name': '教程', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/performance/index.html', 'name': '性能', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/community/index.html', 'name': 'Community', 'selected': 0}, {'link': '//xitu.github.io/tensorflow-docs-web/programmers_guide/index.html', 'name': '开发者指南', 'selected': 0}]
</script>
<!-- Header end -->

<!-- Content start-->
<div class="container-fluid">
    <div class="row">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
    <div class="sidebar-sticky" id="left-nav">

    </div>
</nav>
<script>
    var nav = [{'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/index.html', 'title': '扩展'}, {'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/architecture.html', 'title': 'TensorFlow 架构'}, {'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/adding_an_op.html', 'title': '添加一个新操作（Op）'}, {'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/add_filesys.html', 'title': '添加一个定制的文件系统插件'}, {'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/new_data_formats.html', 'title': '自定义数据读取'}, {'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/language_bindings.html', 'title': '在其他语言中绑定 TensorFlow'}, {'type': 'child', 'link': '//xitu.github.io/tensorflow-docs-web/extend/tool_developers/index.html', 'title': '工具开发者指南：TensorFlow 模型文件'}]
</script>
        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
            <h1>自定义数据读取</h1>
<p>预备知识：</p>
<ul>
<li>  熟悉 C++ 。</li>
<li><a href="//xitu.github.io/tensorflow-docs-web/install/install_sources.html">通过源码安装 TensorFlow</a></li>
</ul>
<p>我们将支持一种文件格式的任务划分为两个部分：</p>
<ul>
<li>  文件格式：我们使用 <strong>读取</strong> 操作从一个文档中读取 <strong>记录</strong>(可以是任意字符串)。</li>
<li>  记录格式：我们使用解码器或解析操作将字符串记录转换成 TensorFlow 可用的 tensor 。</li>
</ul>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/decode_csv"><code>tf.decode_csv</code></a></p>
<p>[TOC]</p>
<h2>为一种文件格式编写读取</h2>
<p><code>Reader</code> 用于从文件中读取记录。TensorFlow 中已经有一些预建好的读取操作样例：</p>
<ul>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/TFRecordReader"><code>tf.TFRecordReader</code></a></li>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/FixedLengthRecordReader"><code>tf.FixedLengthRecordReader</code></a></li>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/TextLineReader"><code>tf.TextLineReader</code></a></li>
</ul>
<p>这些操作暴露的都是一样的接口，唯一的区别在于构造函数不同。最重要的方法是 <code>read</code>。它需要一个队列参数，用于在需要文件名时读取文件名（例如：当 <code>read</code> 操作第一次运行，或者从文件读取最后一条记录时）。它会产生两个标量 tensor：一个字符串键和一个字符串值。</p>
<p>要创建新的名为 <code>SomeReader</code> 的读取操作，你需要：</p>
<ol>
<li> 在 C++ 中，定义<a href="https://www.tensorflow.org/code/tensorflow/core/framework/reader_base.h"><code>tensorflow::ReaderBase</code></a> 的子类 <code>SomeReader</code>。</li>
<li> 在 C++ 中，使用 <code>"SomeReader"</code> 注册一个新的读取操作和内核。</li>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/ReaderBase"><code>tf.ReaderBase</code></a></li>
</ol>
<p>你可以把所有的 C++ 代码放到 <code>tensorflow/core/user_ops/some_reader_op.cc</code> 这个文档中。用于读取文件的代码会运行在 C++ <code>ReaderBase</code> 类的子类中，这个类被定义在 <a href="https://www.tensorflow.org/code/tensorflow/core/framework/reader_base.h"><code>tensorflow/core/kernels/reader_base.h</code></a>。你需要实现以下方法：</p>
<ul>
<li>  <code>OnWorkStartedLocked</code>：打开下一个文件</li>
<li>  <code>ReadLocked</code>：读取记录或者抛出 EOF /错误</li>
<li>  <code>OnWorkFinishedLocked</code>：关闭当前文件，并</li>
<li>  <code>ResetLocked</code>：清除状态，例如在抛出一个错误后</li>
</ul>
<p>这些以“Locked”结尾的方法在调用前，由于 <code>ReaderBase</code> 保证获取到互斥锁，因此你通常不必担心线程安全（尽管这种方式只会保护此类中的成员，而不是全局状态）。</p>
<p>对于 <code>OnWorkStartedLocked</code> 方法，要打开的文件名是 <code>current_work()</code> 方法的返回值。<code>ReadLocked</code> 声明如下：</p>
<pre><code class="lang-c++">Status ReadLocked(string* key, string* value, bool* produced, bool* at_end)
</code></pre>
<p>如果 <code>ReadLocked</code> 成功地从文件中读取到了一个记录，则返回：</p>
<ul>
<li>  <code>*key</code>：记录标识符，可以使用它再次查找此记录。你可以将 <code>current_work()</code> 返回的文件名包含其中，并附上一个记录编码或者其他任何内容。</li>
<li>  <code>*value</code>：记录的内容。</li>
<li>  <code>*produced</code>：设定为 <code>true</code>。</li>
</ul>
<p>如果你到达了文件结尾（EOF），设置 <code>*at_end</code> 为 <code>true</code>。在任何情况下，返回 <code>Status::OK()</code>。如果出现错误，只需使用 <a href="https://www.tensorflow.org/code/tensorflow/core/lib/core/errors.h"><code>tensorflow/core/lib/core/errors.h</code></a> 中的一个助手函数返回它，而不用修改其他参数。</p>
<p><a href="//xitu.github.io/tensorflow-docs-web/./extend/adding_an_op.html">添加一个新操作（Op）</a></p>
<ul>
<li>  注册操作。</li>
<li>  定义并注册一个 <code>OpKernel</code>。</li>
</ul>
<p>要注册这个操作，你需要使用在 <a href="https://www.tensorflow.org/code/tensorflow/core/framework/op.h"><code>tensorflow/core/framework/op.h</code></a> 中定义的 <code>REGISTER_OP</code> 调用。读取操作不接受任何输入，并且总会有一个 <code>resource</code> 类型的输出。它应有字符串类型的 <code>container</code> 和 <code>shared_name</code> 属性。你可以选择为配置或在 <code>Doc</code> 中包含文档定义其他属性。有关示例，请参见 <a href="https://www.tensorflow.org/code/tensorflow/core/ops/io_ops.cc"><code>tensorflow/core/ops/io_ops.cc</code></a> ，例如：</p>
<pre><code class="lang-c++">#include &quot;tensorflow/core/framework/op.h&quot;

REGISTER_OP(&quot;TextLineReader&quot;)
    .Output(&quot;reader_handle: resource&quot;)
    .Attr(&quot;skip_header_lines: int = 0&quot;)
    .Attr(&quot;container: string = &#39;&#39;&quot;)
    .Attr(&quot;shared_name: string = &#39;&#39;&quot;)
    .SetIsStateful()
    .SetShapeFn(shape_inference::ScalarShape)
    .Doc(R&quot;doc(
A Reader that outputs the lines of a file delimited by &#39;\n&#39;.
)doc&quot;);
</code></pre>
<p>读取操作可以使用 <code>ReaderOpKernel</code>（<a href="https://www.tensorflow.org/code/tensorflow/core/framework/reader_op_kernel.h"><code>tensorflow/core/framework/reader_op_kernel.h</code></a>）中的快捷方式来定义一个 <code>OpKernel</code>。定义完类后，你需要使用 <code>REGISTER_KERNEL_BUILDER(...)</code> 注册它。一个没有参数的样例：</p>
<pre><code class="lang-c++">#include &quot;tensorflow/core/framework/reader_op_kernel.h&quot;

class TFRecordReaderOp : public ReaderOpKernel {
 public:
  explicit TFRecordReaderOp(OpKernelConstruction* context)
      : ReaderOpKernel(context) {
    Env* env = context-&gt;env();
    SetReaderFactory([this, env]() { return new TFRecordReader(name(), env); });
  }
};

REGISTER_KERNEL_BUILDER(Name(&quot;TFRecordReader&quot;).Device(DEVICE_CPU),
                        TFRecordReaderOp);
</code></pre>
<p>一个有参数的样例：</p>
<pre><code class="lang-c++">#include &quot;tensorflow/core/framework/reader_op_kernel.h&quot;

class TextLineReaderOp : public ReaderOpKernel {
 public:
  explicit TextLineReaderOp(OpKernelConstruction* context)
      : ReaderOpKernel(context) {
    int skip_header_lines = -1;
    OP_REQUIRES_OK(context,
                   context-&gt;GetAttr(&quot;skip_header_lines&quot;, &amp;skip_header_lines));
    OP_REQUIRES(context, skip_header_lines &gt;= 0,
                errors::InvalidArgument(&quot;skip_header_lines must be &gt;= 0 not &quot;,
                                        skip_header_lines));
    Env* env = context-&gt;env();
    SetReaderFactory([this, skip_header_lines, env]() {
      return new TextLineReader(name(), skip_header_lines, env);
    });
  }
};

REGISTER_KERNEL_BUILDER(Name(&quot;TextLineReader&quot;).Device(DEVICE_CPU),
                        TextLineReaderOp);
</code></pre>
<p><a href="//xitu.github.io/tensorflow-docs-web/./extend/adding_an_op.html#building_the_op_library">添加一个新操作（Op）</a></p>
<pre><code class="lang-python">from tensorflow.python.framework import ops
from tensorflow.python.ops import common_shapes
from tensorflow.python.ops import io_ops

class SomeReader(io_ops.ReaderBase):

    def __init__(self, name=None):
        rr = gen_user_ops.some_reader(name=name)
        super(SomeReader, self).__init__(rr)


ops.NotDifferentiable(&quot;SomeReader&quot;)
</code></pre>
<p>你可以在 <a href="https://www.tensorflow.org/code/tensorflow/python/ops/io_ops.py"><code>tensorflow/python/ops/io_ops.py</code></a> 中查看一些样例。</p>
<h2>为记录格式编写操作</h2>
<p><a href="//xitu.github.io/tensorflow-docs-web/./extend/adding_an_op.html">添加一个新操作（Op）</a></p>
<p>用于解码记录的操作示例：</p>
<ul>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/parse_example"><code>tf.parse_example</code></a></li>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/decode_csv"><code>tf.decode_csv</code></a></li>
<li><a href="https://www.tensorflow.org/api_docs/python/tf/decode_raw"><code>tf.decode_raw</code></a></li>
</ul>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/reshape"><code>tf.reshape</code></a></p>

        </main>
    </div>
</div>
<!-- Content end-->
</body>
<script src="//cdn.bootcss.com/jquery/3.3.1/jquery.slim.min.js" type="text/javascript"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js" type="text/javascript"></script>
<script src="//xitu.github.io/tensorflow-docs-web/assets/js/main.js" type="text/javascript"></script>
</html>